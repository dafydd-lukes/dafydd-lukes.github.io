<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Text munching in R? - Little Umbrellas</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">




<style type="text/css">

/*some stuff for output/input prompts*/
div.cell{border:1px solid transparent;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch}div.cell.selected{border-radius:4px;border:thin #ababab solid}
div.cell.edit_mode{border-radius:4px;border:thin #008000 solid}
div.cell{width:100%;padding:5px 5px 5px 0;margin:0;outline:none}
div.prompt{min-width:11ex;padding:.4em;margin:0;font-family:monospace;text-align:right;line-height:1.21429em}
@media (max-width:480px){div.prompt{text-align:left}}div.inner_cell{display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch;-webkit-box-flex:1;-moz-box-flex:1;box-flex:1;flex:1}
div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;line-height:1.21429em}
div.prompt:empty{padding-top:0;padding-bottom:0}
div.input{page-break-inside:avoid;display:-webkit-box;-webkit-box-orient:horizontal;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:horizontal;-moz-box-align:stretch;display:box;box-orient:horizontal;box-align:stretch;}
div.inner_cell{width:90%;}
div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;}
div.input_prompt{color:navy;border-top:1px solid transparent;}
div.output_wrapper{margin-top:5px;position:relative;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
div.output_scroll{height:24em;width:100%;overflow:auto;border-radius:4px;-webkit-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);-moz-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);}
div.output_collapsed{margin:0px;padding:0px;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
div.out_prompt_overlay{height:100%;padding:0px 0.4em;position:absolute;border-radius:4px;}
div.out_prompt_overlay:hover{-webkit-box-shadow:inset 0 0 1px #000000;-moz-box-shadow:inset 0 0 1px #000000;box-shadow:inset 0 0 1px #000000;background:rgba(240, 240, 240, 0.5);}
div.output_prompt{color:darkred;}

a.anchor-link:link{text-decoration:none;padding:0px 20px;visibility:hidden;}
h1:hover .anchor-link,h2:hover .anchor-link,h3:hover .anchor-link,h4:hover .anchor-link,h5:hover .anchor-link,h6:hover .anchor-link{visibility:visible;}
/* end stuff for output/input prompts*/


.highlight-ipynb .hll { background-color: #ffffcc }
.highlight-ipynb  { background: #f8f8f8; }
.highlight-ipynb .c { color: #408080; font-style: italic } /* Comment */
.highlight-ipynb .err { border: 1px solid #FF0000 } /* Error */
.highlight-ipynb .k { color: #008000; font-weight: bold } /* Keyword */
.highlight-ipynb .o { color: #666666 } /* Operator */
.highlight-ipynb .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight-ipynb .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight-ipynb .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight-ipynb .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight-ipynb .gd { color: #A00000 } /* Generic.Deleted */
.highlight-ipynb .ge { font-style: italic } /* Generic.Emph */
.highlight-ipynb .gr { color: #FF0000 } /* Generic.Error */
.highlight-ipynb .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight-ipynb .gi { color: #00A000 } /* Generic.Inserted */
.highlight-ipynb .go { color: #888888 } /* Generic.Output */
.highlight-ipynb .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight-ipynb .gs { font-weight: bold } /* Generic.Strong */
.highlight-ipynb .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight-ipynb .gt { color: #0044DD } /* Generic.Traceback */
.highlight-ipynb .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight-ipynb .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight-ipynb .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight-ipynb .kp { color: #008000 } /* Keyword.Pseudo */
.highlight-ipynb .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight-ipynb .kt { color: #B00040 } /* Keyword.Type */
.highlight-ipynb .m { color: #666666 } /* Literal.Number */
.highlight-ipynb .s { color: #BA2121 } /* Literal.String */
.highlight-ipynb .na { color: #7D9029 } /* Name.Attribute */
.highlight-ipynb .nb { color: #008000 } /* Name.Builtin */
.highlight-ipynb .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight-ipynb .no { color: #880000 } /* Name.Constant */
.highlight-ipynb .nd { color: #AA22FF } /* Name.Decorator */
.highlight-ipynb .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight-ipynb .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight-ipynb .nf { color: #0000FF } /* Name.Function */
.highlight-ipynb .nl { color: #A0A000 } /* Name.Label */
.highlight-ipynb .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight-ipynb .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight-ipynb .nv { color: #19177C } /* Name.Variable */
.highlight-ipynb .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight-ipynb .w { color: #bbbbbb } /* Text.Whitespace */
.highlight-ipynb .mf { color: #666666 } /* Literal.Number.Float */
.highlight-ipynb .mh { color: #666666 } /* Literal.Number.Hex */
.highlight-ipynb .mi { color: #666666 } /* Literal.Number.Integer */
.highlight-ipynb .mo { color: #666666 } /* Literal.Number.Oct */
.highlight-ipynb .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight-ipynb .sc { color: #BA2121 } /* Literal.String.Char */
.highlight-ipynb .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight-ipynb .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight-ipynb .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight-ipynb .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight-ipynb .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight-ipynb .sx { color: #008000 } /* Literal.String.Other */
.highlight-ipynb .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight-ipynb .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight-ipynb .ss { color: #19177C } /* Literal.String.Symbol */
.highlight-ipynb .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight-ipynb .vc { color: #19177C } /* Name.Variable.Class */
.highlight-ipynb .vg { color: #19177C } /* Name.Variable.Global */
.highlight-ipynb .vi { color: #19177C } /* Name.Variable.Instance */
.highlight-ipynb .il { color: #666666 } /* Literal.Number.Integer.Long */
</style>

<style type="text/css">
/* Overrides of notebook CSS for static HTML export */
div.entry-content {
  overflow: visible;
  padding: 8px;
}
.input_area {
  padding: 0.2em;
}

a.heading-anchor {
 white-space: normal;
}

.rendered_html
code {
 font-size: .8em;
}

pre.ipynb {
  color: black;
  background: #f7f7f7;
  border: none;
  box-shadow: none;
  margin-bottom: 0;
  padding: 0;
  margin: 0px;
  font-size: 13px;
}

/* remove the prompt div from text cells */
div.text_cell .prompt {
    display: none;
}

/* remove horizontal padding from text cells, */
/* so it aligns with outer body text */
div.text_cell_render {
    padding: 0.5em 0em;
}

img.anim_icon{padding:0; border:0; vertical-align:middle; -webkit-box-shadow:none; -box-shadow:none}
</style>

<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
<script type="text/javascript">
init_mathjax = function() {
    if (window.MathJax) {
        // MathJax loaded
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
            },
            displayAlign: 'left', // Change this to 'center' to center equations.
            "HTML-CSS": {
                styles: {'.MathJax_Display': {"margin": 0}}
            }
        });
        MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
    }
}
init_mathjax();
</script>
    <link href="https://dlukes.github.io/images/favicon.ico" rel="icon">

<link rel="canonical" href="https://dlukes.github.io/text-munching-in-r.html">

        <meta name="author" content="dlukes" />
        <meta name="keywords" content="python,r,rust,perl,text processing" />
        <meta name="description" content="Is R suited for processing large quantities of text data?" />

        <meta property="og:site_name" content="Little Umbrellas" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Text munching in R?"/>
        <meta property="og:url" content="https://dlukes.github.io/text-munching-in-r.html"/>
        <meta property="og:description" content="Is R suited for processing large quantities of text data?"/>
        <meta property="article:published_time" content="2017-10-28" />
            <meta property="article:section" content="ling" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="r" />
            <meta property="article:tag" content="rust" />
            <meta property="article:tag" content="perl" />
            <meta property="article:tag" content="text processing" />
            <meta property="article:author" content="dlukes" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://dlukes.github.io/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://dlukes.github.io/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://dlukes.github.io/theme/css/pygments/zenburn.css" rel="stylesheet">
    <link href="https://dlukes.github.io/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://dlukes.github.io/theme/css/style.css" type="text/css"/>
        <link href="https://dlukes.github.io/static/custom.css" rel="stylesheet">

        <link href="https://dlukes.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Little Umbrellas ATOM Feed"/>



        <link href="https://dlukes.github.io/feeds/ling.atom.xml" type="application/atom+xml" rel="alternate"
              title="Little Umbrellas ling ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://dlukes.github.io/" class="navbar-brand">
Little Umbrellas            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://dlukes.github.io/pages/about.html">
                             about me
                          </a></li>
                         <li><a href="https://dlukes.github.io/pages/work.html">
                             work
                          </a></li>
                        <li >
                            <a href="https://dlukes.github.io/category/floss.html">floss</a>
                        </li>
                        <li class="active">
                            <a href="https://dlukes.github.io/category/ling.html">ling</a>
                        </li>
                        <li >
                            <a href="https://dlukes.github.io/category/macos.html">macOS</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://dlukes.github.io/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://dlukes.github.io/text-munching-in-r.html"
                       rel="bookmark"
                       title="Permalink to Text munching in R?">
                        Text munching in R?
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-10-28T00:00:00+02:00"> Sat 28 October 2017</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://dlukes.github.io/tag/python.html">python</a>
        /
	<a href="https://dlukes.github.io/tag/r.html">r</a>
        /
	<a href="https://dlukes.github.io/tag/rust.html">rust</a>
        /
	<a href="https://dlukes.github.io/tag/perl.html">perl</a>
        /
	<a href="https://dlukes.github.io/tag/text-processing.html">text processing</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>R has been <a href="https://stackoverflow.blog/2017/10/10/impressive-growth-r/">gaining traction</a> as a language for data analysis. My
feelings about the whole ecosystem are mixed -- it has some <a href="https://www.tidyverse.org/">incredibly
well-designed libraries</a> and a <a href="https://www.rstudio.com/">top-of-the-game IDE</a>, but
the core language makes me cringe (it feels like "Perl and Lisp: The Worse
Parts"). Be that as it may, it has undeniably become the go-to programming
language for many people for whom programming is not their main breadwinner,
many linguists among them. If you're one of these people and wondering whether
it's worth undergoing the cognitive burden of learning another language and
having to context-switch between them, read on!</p>
<p>The main problem with R and large data is of course that R is fast as long as
you can load everything into memory at once and use vectorized operations. The
whole point of this post is that with the current size of a typical corpus, you
often can't do that. You'll have to process the corpus line by line, which
means using a for-loop, and these are notoriously slow in R. I'm not pretending
this is some new discovery (it's not), I'm just trying to quantify how
problematic this slowness is for processing large quantities of text
(prohibitive, in my opinion), so that you don't have to figure it out for
yourself and can get started <a href="http://www.nltk.org/book/">learning Python 3</a> right away instead
;)</p>
<p>(Another big problem is that R doesn't have an efficient and versatile hash
table data structure.)</p>
<h1>tl;dr</h1>
<p>If you're planning to process corpora of hundreds of millions of tokens or more
-- spoiler alert, you probably shouldn't do it in R.</p>
<h1>Task</h1>
<p>OK, I've specifically complained about R being bad at for-loops and hashes.
Let's devise a task that'll show exactly how bad. At the same time, I don't
mean to come up with anything particularly convoluted or far-fetched. So here
goes: we'll be trying to build a per-part-of-speech frequency distribution of
lemmas (dictionary headword forms) from a 120M-token corpus. If you've ever
done any linguistic data analysis, I hope you'll agree it's a pretty basic and
common task.</p>
<p>The corpus data consists of lines with tab-separated word form, lemma and tag
fields, plus some additional lines with metadata which do not contain tabs.
We'll be skipping those. Here's a glimpse of the corpus format:</p>
<div class="highlight"><pre><span></span><span class="c">&lt;!--</span>
<span class="c">WORD     LEMMA    TAG --&gt;</span>
Hladina  hladina  NNFS1-----A-----
jezera   jezero   NNNS2-----A-----
,        ,        Z:--------------
mrtvá    mrtvý    AAFS1----1A-----
a        a        J^--------------
černá    černý    AAFS1----1A-----
,        ,        Z:--------------
</pre></div>


<p>The first character of the tag indicates the part of speech. For each part of
speech, we want to create a separate frequency distribution, i.e. we want to be
able to say, for instance, the most frequent noun is X, followed by Y, whereas
the most frequent adjective is Z etc. This should nicely exercise all of R's
weak spots. Let's get to it!</p>
<h1>R: 1 day (!) / 15 hours (see EDIT below, but still !)</h1>
<p>After quite some exploration of various alternatives for the individual
subtasks, this is the program that I came up with:</p>
<div class="highlight"><pre><span></span><span class="kn">library</span><span class="p">(</span>stringi<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>hash<span class="p">)</span>

<span class="c1"># read input from STDIN</span>
con <span class="o">&lt;-</span> <span class="kp">file</span><span class="p">(</span><span class="s">&quot;stdin&quot;</span><span class="p">,</span> open<span class="o">=</span><span class="s">&quot;rt&quot;</span><span class="p">)</span>

pos_sets <span class="o">&lt;-</span> hash<span class="p">()</span>
start <span class="o">&lt;-</span> <span class="kp">Sys.time</span><span class="p">()</span>
<span class="kr">while</span> <span class="p">(</span><span class="kc">TRUE</span><span class="p">)</span> <span class="p">{</span>
  line <span class="o">&lt;-</span> <span class="kp">readLines</span><span class="p">(</span>con<span class="p">,</span> n<span class="o">=</span><span class="m">1</span><span class="p">)</span>
  <span class="kr">if</span> <span class="p">(</span><span class="kp">length</span><span class="p">(</span>line<span class="p">)</span> <span class="o">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">break</span>
  <span class="p">}</span>
  <span class="c1"># lines with tokens (as opposed to metadata) contain tabs</span>
  <span class="kr">if</span> <span class="p">(</span>stri_detect_fixed<span class="p">(</span>line<span class="p">,</span> <span class="s">&quot;\t&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1"># individual token attributes are tab-separated</span>
    attrs <span class="o">&lt;-</span> stri_split_fixed<span class="p">(</span>line<span class="p">,</span> <span class="s">&quot;\t&quot;</span><span class="p">)</span>
    <span class="c1"># for each token, we&#39;re interested in the lemma (headword)...</span>
    lemma <span class="o">&lt;-</span> attrs<span class="p">[[</span><span class="m">1</span><span class="p">]][</span><span class="m">2</span><span class="p">]</span>
    <span class="c1"># ... and the part-of-speech, which is the first character of the tag</span>
    tag <span class="o">&lt;-</span> attrs<span class="p">[[</span><span class="m">1</span><span class="p">]][</span><span class="m">3</span><span class="p">]</span>
    pos <span class="o">&lt;-</span> stri_split_boundaries<span class="p">(</span>tag<span class="p">,</span> n<span class="o">=</span><span class="m">2</span><span class="p">,</span> type<span class="o">=</span><span class="s">&quot;character&quot;</span><span class="p">)[[</span><span class="m">1</span><span class="p">]][</span><span class="m">1</span><span class="p">]</span>
    <span class="c1"># build a per-part-of-speech frequency distribution as a nested hash:</span>
    <span class="c1"># {</span>
    <span class="c1">#   &quot;noun&quot;: {</span>
    <span class="c1">#     &quot;cat&quot;: 5,</span>
    <span class="c1">#     &quot;dog&quot;: 3,</span>
    <span class="c1">#     ...</span>
    <span class="c1">#   },</span>
    <span class="c1">#   &quot;verb&quot;: {</span>
    <span class="c1">#     &quot;look&quot;: 2,</span>
    <span class="c1">#     ...</span>
    <span class="c1">#   },</span>
    <span class="c1">#   ...</span>
    <span class="c1"># }</span>
    <span class="kr">if</span> <span class="p">(</span><span class="kp">is.null</span><span class="p">(</span>pos_sets<span class="p">[[</span>pos<span class="p">]]))</span> <span class="p">{</span>
      pos_sets<span class="p">[[</span>pos<span class="p">]]</span> <span class="o">&lt;-</span> hash<span class="p">()</span>
    <span class="p">}</span>
    <span class="kr">if</span> <span class="p">(</span><span class="kp">is.null</span><span class="p">(</span>pos_sets<span class="p">[[</span>pos<span class="p">]][[</span>lemma<span class="p">]]))</span> <span class="p">{</span>
      pos_sets<span class="p">[[</span>pos<span class="p">]][[</span>lemma<span class="p">]]</span> <span class="o">&lt;-</span> <span class="m">1</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
      pos_sets<span class="p">[[</span>pos<span class="p">]][[</span>lemma<span class="p">]]</span> <span class="o">&lt;-</span> pos_sets<span class="p">[[</span>pos<span class="p">]][[</span>lemma<span class="p">]]</span> <span class="o">+</span> <span class="m">1</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># report running time</span>
diff <span class="o">&lt;-</span> <span class="kp">Sys.time</span><span class="p">()</span> <span class="o">-</span> start
<span class="kp">cat</span><span class="p">(</span><span class="kp">sprintf</span><span class="p">(</span><span class="s">&quot;Done in %g %s.\n&quot;</span><span class="p">,</span> <span class="kp">diff</span><span class="p">,</span> <span class="kp">units</span><span class="p">(</span><span class="kp">diff</span><span class="p">)),</span> file<span class="o">=</span><span class="kp">stderr</span><span class="p">())</span>
</pre></div>


<p>Given the input corpus mentioned above, this code takes <strong>1.33</strong> days to run.
Compared to other languages one might conceivably use (see below), this is just
ridiculous.</p>
<p>Now, I'm certainly not an expert in R, so there may be better ways of doing
some of this. But I doubt such improvements, if any, would be of any practical
relevance, because even reducing the running time to <em>a tenth</em> of the original
duration wouldn't be enough. And if there <em>is</em> a way to go even further, say to
a hundredth, which would begin to make R competitive, then I would argue that a
language which lets you shoot yourself so spectacularly in the foot
performance-wise if you're not hip to some clever tricks should just be avoided
for tasks where said performance matters.</p>
<hr>
<p><strong>EDIT:</strong> Replacing <code>stri_split_boundaries(tag, n=2, type="character")[[1]][1]</code>
above with <code>stri_sub(tag, from=1, to=1)</code>, you can cut the running time down to
15 hours. That's still way too much in comparison with the competitors, and
just reinforces one of the points made below: there's often no default and
efficient way of doing some basic operations (like string manipulation) in R.</p>
<p>This is in great part due to R's emphasis on vectorization, which leads to a
proliferation of subtly different functions designed for doing subtly different
kinds of vectorized passes over data. Good luck trying to remember them all.
And if you pick the wrong one (cf. <code>stri_split_boundaries()</code> vs. <code>stri_sub()</code>)
-- because there are just too many similar ways of achieving the same result
and too much documentation to read before you even begin to see what you should
use -- you get penalized heavily. This is very programmer-unfriendly design.</p>
<p>Contrast this with the <a href="https://www.python.org/dev/peps/pep-0020/#the-zen-of-python">Zen of Python</a>: "There should be one -- and
preferably only one -- obvious way to do it."</p>
<hr>
<p>With these general considerations out of the way, let's look at some details of
how to implement this task in R. In many cases, it's unclear how you should
even approach the problem in R, due to <strong>missing or confusing built-in
functionality</strong>. As a result, in addition to having a lousy running time on
this task, R also puts a strain on the programmer's time.</p>
<h2>Reading the data</h2>
<p>This sounds so basic it should be obvious, right? Not so fast.</p>
<p>First of all, the <code>file("path/to/file")</code> function creates a file connection,
which is however not open unless you also specify a mode in the <code>open=</code>
argument, or alternatively, unless you call the <code>open()</code> function on the
connection. Why you would want to create a connection that's not open is beyond
me, but R adds insult to injury by allowing <code>readLines()</code> to work on a closed
connection: it just opens the connection before doing the reading and closes it
afterwards. This means that repeated calls to <code>readLines(unopened_connection,
n=1)</code> will <strong>repeatedly read the first line of the file</strong>, which is most likely
not what you want. This is API design level PHP.</p>
<p>Second, the corpus is gzip compressed, so you'll need to uncompress it. There
are basically two options:</p>
<ol>
<li>have an external program (<code>zcat</code>) do the decompression and pipe the data
   into R via <code>STDIN</code></li>
<li>handle the decompression within R itself</li>
</ol>
<p>As a general rule (for any language), it will always be faster to handle the
decompression in a different process on a multi-core system, because the tasks
can proceed in parallel.<sup id="fnref-1"><a class="footnote-ref" href="#fn-1">1</a></sup> On the other hand, it's more portable not to
depend on external programs, and R does have a built-in function to open a
connection to a gzipped file, namely <code>gzfile()</code>. Based on tests on shorter
inputs, it's about 50% slower than external decompression, which is a somewhat
worse performance deterioration than e.g. Python 3 (40% based on the full
input). In light of the already dire running time, it's something we can't
really afford.</p>
<p>Third, having to do the line-by-line reading in a <code>while (TRUE)</code> loop, using a
function called <code>readLines()</code> (note the plural) with an argument of <code>1</code>,
checking the length of the resulting character vector in order to determine the
end of the input -- that's just gross.</p>
<h2>String manipulation</h2>
<p>R has built-in functions for string matching (<code>grepl()</code> et al.), not so much
for string splitting. This is the point where I got suspicious of the
performance of everything and started testing alternatives. I finally ended up
using the <a href="http://www.gagolewski.com/software/stringi/">stringi</a> package, which is fast and has a fairly consistent
API. <a href="https://cran.r-project.org/web/packages/stringr/vignettes/stringr.html">stringr</a> is a set of higher-level wrappers around it, which have
however proven somewhat slower than the built-ins in my highly informal
testing.</p>
<h2>O hash map, where art thou?</h2>
<p>Building a per-part-of-speech frequency distribution of headwords requires an
appropriate data structure. As indicated in the comments in the R source, we
want to build a nested collection that looks something like this:</p>
<div class="highlight"><pre><span></span>{
  &quot;noun&quot;: {
    &quot;cat&quot;: 5,
    &quot;dog&quot;: 3,
    ...
  },
  &quot;verb&quot;: {
    &quot;look&quot;: 2,
    ...
  },
  ...
}
</pre></div>


<p>The requirements on the data structure we need are the following:</p>
<ol>
<li>it's a collection</li>
<li>strings can be used as keys</li>
<li>it can be arbitrarily nested</li>
<li>key lookup is fast, i.e. constant time</li>
</ol>
<p>In other words, we need a hash (or a dict, in Python terminology). R doesn't
<em>have</em> a hash (I'll qualify this statement in a bit).</p>
<p>The workhorse data structure in R that satisfies points 1--3 is a list.
Unfortunately, it has <a href="https://stackoverflow.com/questions/41353298/what-is-the-time-complexity-of-name-look-up-in-an-r-list">linear access time</a>. That's not going to work.</p>
<p>R also has environments, which it uses to store and access variables. Under the
hood, environments are implemented as hashes, but using them as such is a
massive pain, because their API isn't meant for it. Fortunately, there's <a href="https://cran.r-project.org/web/packages/hash/index.html">a
wrapper package</a> which makes it more convenient. Unfortunately,
environments weren't optimized with this use case in mind. They were designed
to hold key--value (variable name--variable value) pairs explicitly defined by
people as part of their programs, not millions of items extracted from data. As
a result, they <a href="http://appsilondatascience.com/blog/rstats/2017/03/02/r-fast-lookup.html">slow down dramatically</a> once the number of items
grows large.</p>
<p>(The article in the previous link provides a survey of the state of the art of
fast key lookup in R. The state of the art is... dismal. Your only option is
basically indexing a data table, which is fine for a finalized data set, but
useless when <em>building the data set</em> -- you can't afford to reindex after each
new data point.)</p>
<p>There's also the <a href="https://cran.r-project.org/web/packages/hashmap/index.html">hashmap library</a>, which is a wrapper around C++
Boost hashes. However, it doesn't do nesting, so it's of no use to us, and of
very limited usefulness in general.</p>
<p>Conclusion: technically, we have to concede that R has hashes, but <strong>for all
practical intents and purposes, it doesn't</strong>.</p>
<p>There's one last twist, though. Funnily enough, in our use case, it turns out
it doesn't really matter anyway. Indeed, it seems the performance of for-loops
in R is <em>so egregiously bad</em> that it dwarfs even the inefficiencies accrued by
the linear lookup time of lists: if you reimplement the script with lists, it
takes just a little longer than the version with hashes, about 1.36 days.</p>
<p>(Or maybe it's just that the performance of environment-based hashes becomes so
bad when they grow large as to be comparable with that of lists? Who knows, and
frankly, I don't care enough to want to find out. If it's the for-loops though,
then adding efficient hashes to R won't really solve anything.)</p>
<hr>
<p><strong>EDIT:</strong> With <code>stri_sub()</code> substituted for <code>stri_split_boundaries()</code> as
detailed above, the code using lists runs in about 1.28 days, which is a much
smaller improvement than in the case of the code using hashes (1.33 days → 15
hours).</p>
<hr>
<h2>Summary</h2>
<p>If you like R and your reaction to this is, "That's not fair! R was never meant
to do any of this, that's why everything feels so backhanded." -- then good,
that's basically the gist of this post: <strong>don't use R for something it wasn't
meant to do</strong>.</p>
<p>What are the alternatives, then?</p>
<h1>Task</h1>
<p>The following details an informal test comparing the speed of R, Python 3, Rust
and Perl at processing a large corpus file (~120M tokens, 1.5GB gzipped) and
creating a frequency distribution of headwords per part-of-speech. The idea is
to see whether R is a viable alternative in this domain, or whether the slowing
down caused by the inability to use vectorized computations (because we can't
load the entire thing into memory at once) will just be too much.</p>
<h1>Python 3: 5 minutes</h1>
<p>Yes, that's right. It takes Python 3 <strong>5 minutes</strong> to do the same task that
took R <strong>over a day</strong>. The code feels a lot simpler too:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">pos_sets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">lemma</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># this is an intentionally naive implementation which mimicks</span>
            <span class="c1"># the R code and something an inexperienced coder might do;</span>
            <span class="c1"># a more concise and probably better performing solution could</span>
            <span class="c1"># be achieved using dict.setdefault() or collections.defaultdict</span>
            <span class="c1"># / collections.Counter</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pos_sets</span><span class="p">:</span>
                <span class="n">pos_sets</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">lemma</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pos_sets</span><span class="p">[</span><span class="n">pos</span><span class="p">]:</span>
                <span class="n">pos_sets</span><span class="p">[</span><span class="n">pos</span><span class="p">][</span><span class="n">lemma</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos_sets</span><span class="p">[</span><span class="n">pos</span><span class="p">][</span><span class="n">lemma</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">diff</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Done in {diff:.0f} seconds.&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>


<p>FYI, this was run using Python 3.6. As a rule, use always the most recent
version of Python 3 you can (at least 3.5, 3.4 in a pinch; with earlier
releases, you may encounter performance issues). In any case, <strong>do not use
Python 2</strong> for new projects and let it end-of-life in peace.</p>
<h1>Perl: 13 minutes</h1>
<p>Perl used to be a popular alternative for text processing. Like R, it has its
fair share of nauseating language design and weird quirks, but since it was
actually meant for use in this domain, it won't spectacularly let you down.</p>
<p>(Unless your data is silently corrupted because you handled text encoding
wrong. Perl's behavior in this respect is a relict of a pre-UTF-8-everywhere
past, and it's the single biggest reason for why the language should be put out
of its misery already.)</p>
<p>Here's the code:</p>
<div class="highlight"><pre><span></span><span class="k">use</span> <span class="nn">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">utf8</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">open</span> <span class="sx">qw(:std :encoding(utf8))</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$start</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<span class="k">my</span> <span class="nv">%pos_sets</span> <span class="o">=</span> <span class="p">();</span>
<span class="k">while</span> <span class="p">(</span><span class="o">&lt;&gt;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="sr">/\t/</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">@attrs</span> <span class="o">=</span> <span class="nb">split</span> <span class="sr">/\t/</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$lemma</span> <span class="o">=</span> <span class="nv">@attrs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">my</span> <span class="nv">$tag</span> <span class="o">=</span> <span class="nv">@attrs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="k">my</span> <span class="nv">$pos</span> <span class="o">=</span> <span class="nb">substr</span> <span class="nv">$tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1"># auto-vivification: ergonomic, but also made possible by the whole</span>
    <span class="c1"># &quot;implicit defaults that have a potential of screwing stuff up</span>
    <span class="c1"># without you even knowing about it&quot; culture of Perl</span>
    <span class="nv">$pos_sets</span><span class="p">{</span><span class="nv">$pos</span><span class="p">}{</span><span class="nv">$lemma</span><span class="p">}</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">$diff</span> <span class="o">=</span> <span class="nb">time</span><span class="p">()</span> <span class="o">-</span> <span class="nv">$start</span><span class="p">;</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Done in $diff seconds.\n&quot;</span><span class="p">;</span>
</pre></div>


<p>Bottom line though, being more than twice as slow as Python 3 (which came as a
surprise to me, I must admit) and definitely the worse language, it has little
to recommend itself if you're considering to learn a new language for this type
of task.</p>
<p>Except maybe if you want to continuously log what the program is doing to a
terminal -- like output the number of lines processed after each line. Perl is
clearly very efficient at writing to a terminal, the running time is basically
the same with continuous logging incorporated. By contrast, Python 3 takes
about three times longer (~ 15 minutes).</p>
<p>(I guess maybe Python flushes output after each <code>print()</code> call, whereas Perl
does some smart buffering which results in it not being slowed down by the
latency of the terminal...? Who knows, at any rate, it's hardly a "killer"
feature.)</p>
<h1>Rust: 1.25 minutes</h1>
<p>As a compiled, systems-level language, Rust is in a different league compared
to the previous contestants: of course it's going to be faster. I included it
because it provides a frame of reference. The important takeaway is that we're
in the same ballpark with Python 3 (roughly units of minutes), so there's no
pressing need to turn to a compiled language for this task.</p>
<p>Here's the code, for completeness sake:</p>
<div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">prelude</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">time</span><span class="p">;</span><span class="w"></span>

<span class="k">type</span> <span class="nc">LemmaCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="k">type</span> <span class="nc">PosSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">char</span><span class="p">,</span><span class="w"> </span><span class="n">LemmaCount</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span>::<span class="n">SystemTime</span>::<span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pos_sets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PosSet</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stdin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span>::<span class="n">stdin</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">stdin</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">lines</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">line</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">).</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">lemma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attrs</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attrs</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tag</span><span class="p">.</span><span class="n">chars</span><span class="p">().</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">pos_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos_sets</span><span class="p">.</span><span class="n">entry</span><span class="p">(</span><span class="n">pos</span><span class="p">).</span><span class="n">or_insert</span><span class="p">(</span><span class="n">LemmaCount</span>::<span class="n">new</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">count_for_lemma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos_set</span><span class="p">.</span><span class="n">entry</span><span class="p">(</span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">lemma</span><span class="p">)).</span><span class="n">or_insert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="n">count_for_lemma</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">elapsed</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">as_secs</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Done in {:.0} seconds.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Note in passing how nicely the Rust code reads for a compiled language. Of
course, since it's a much stricter (and safer) language than Python, it's more
ceremonious to write and the APIs are more complicated, because they have to
adhere to the various memory management guarantees Rust gives you (among other
things). But once the code is written, it's very readable and clear. And all
necessary functions and data structures are (a) available in the standard
library, and (b) plenty efficient.</p>
<h1>Conclusion</h1>
<p>Just to be clear: the ultimate purpose of this post is <strong>not</strong> bashing R (not
for being slow at text munching, at any rate); it's to give a convincing
account of why it's just not the right tool for the job. And not in a small
way, either -- in a way that requires to learn a different tool, there's no way
around it. Let me reiterate that my recommendation would hands down be <a href="http://www.nltk.org/book/">Python
3</a>.</p>
<p>Once the data is extracted, go back to R by all means. Although
Python does have a fairly nice high-level <a href="http://pandas.pydata.org/">data analysis library</a>, it's
not my intention to discourage anyone from using R for what it <em>is</em> good at,
especially if this is a skill they are already proficient in.</p>
<p>The internet is full of people asking advice on which programming language to
learn, and the answers are invariably evasive -- it depends on your tastes,
what fits your brain better, what your use case is. In the hopes that some
people might find opinionated guidance useful for a change (I know I personally
often do, when flirting with a new language): if you're looking to process
large quantities of text data, the answer is a big, resounding <strong>NOT R</strong>!</p>
<h1>A vectorized postscript</h1>
<p>Since I ran these on a server with 64 GB of RAM, I figured I might as well try
loading everything into memory in R and doing it the proper, vectorized way,
while I'm at it. Here's the code, using <code>dplyr</code>:</p>
<div class="highlight"><pre><span></span><span class="kn">library</span><span class="p">(</span>dplyr<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>stringi<span class="p">)</span>

start <span class="o">&lt;-</span> <span class="kp">Sys.time</span><span class="p">()</span>

con <span class="o">&lt;-</span> <span class="kp">file</span><span class="p">(</span><span class="s">&quot;stdin&quot;</span><span class="p">,</span> open<span class="o">=</span><span class="s">&quot;rt&quot;</span><span class="p">)</span>
corpus <span class="o">&lt;-</span> <span class="kp">readLines</span><span class="p">(</span>con<span class="p">)</span>

diff <span class="o">&lt;-</span> <span class="kp">Sys.time</span><span class="p">()</span> <span class="o">-</span> start
<span class="kp">cat</span><span class="p">(</span><span class="kp">sprintf</span><span class="p">(</span><span class="s">&quot;Corpus read in after %g %s.\n&quot;</span><span class="p">,</span> <span class="kp">diff</span><span class="p">,</span> <span class="kp">units</span><span class="p">(</span><span class="kp">diff</span><span class="p">)))</span>

corpus <span class="o">&lt;-</span> stri_subset_fixed<span class="p">(</span>corpus<span class="p">,</span> <span class="s">&quot;\t&quot;</span><span class="p">)</span>
corpus <span class="o">&lt;-</span> stri_split_fixed<span class="p">(</span>corpus<span class="p">,</span> <span class="s">&quot;\t&quot;</span><span class="p">,</span> simplify<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
freq_dist <span class="o">&lt;-</span> tibble<span class="p">(</span>
  POS<span class="o">=</span>stri_sub<span class="p">(</span>corpus<span class="p">[,</span> <span class="m">3</span><span class="p">],</span> from<span class="o">=</span><span class="m">1</span><span class="p">,</span> to<span class="o">=</span><span class="m">1</span><span class="p">),</span>
  LEMMA<span class="o">=</span>corpus<span class="p">[,</span> <span class="m">2</span><span class="p">]</span>
<span class="p">)</span> <span class="o">%&gt;%</span>
  group_by<span class="p">(</span>POS<span class="p">,</span> LEMMA<span class="p">)</span> <span class="o">%&gt;%</span>
  summarize<span class="p">(</span>FREQ<span class="o">=</span>n<span class="p">())</span>

diff <span class="o">&lt;-</span> <span class="kp">Sys.time</span><span class="p">()</span> <span class="o">-</span> start
<span class="kp">cat</span><span class="p">(</span><span class="kp">sprintf</span><span class="p">(</span><span class="s">&quot;Finished processing corpus after %g %s.\n&quot;</span><span class="p">,</span> <span class="kp">diff</span><span class="p">,</span> <span class="kp">units</span><span class="p">(</span><span class="kp">diff</span><span class="p">)))</span>
</pre></div>


<p>Let me say at the outset that this code looks much nicer -- it's clean, modern
R, made possible in great part by Hadley Wickham's efforts to redesign the data
manipulation vocabulary from the ground up. Note also that we've made a
concession on our requirements: the resulting data structure is a tibble, not a
hash, i.e. key lookup time is not constant but depends on the size of the data.</p>
<p>Well, just loading the corpus into memory took ~18 minutes. The script then ran
for <strong>several days</strong>, in the course of which I checked every now and then to
see how much memory it was using: ~35 GB. I don't suppose anyone has that much
RAM on their laptop. Then someone rebooted the server before the program could
complete. I think you'll agree the experiment is conclusive even so.</p>
<!----------------------------- LINKS AND NOTES ----------------------------->

<div class="footnote">
<hr>
<ol>
<li id="fn-1">
<p>You could also offload the decompression to a different thread in the
same process, but that complicates the implementation. Piping gives you
parallelization basically for free.&#160;<a class="footnote-backref" href="#fnref-1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'littleumbrellas'; // required: replace example with your forum shortname

                    var disqus_identifier = 'text-munching-in-r';
                var disqus_url = 'https://dlukes.github.io/text-munching-in-r.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="/images/avatar.jpeg"/>
        </p>
    <p>
        <strong>About dlukes</strong><br/>
        Language tourist, Python enthusiast & Frank Zappa aficionado
    </p>
</div>
<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/dlukes"><i class="fa fa-github-square fa-lg"></i> github</a></li>
                <li class="list-group-item"><a href="http://stackoverflow.com/users/1826241/dlukes"><i class="fa fa-stack-overflow fa-lg"></i> stack overflow</a></li>
                <li class="list-group-item"><a href="https://plus.google.com/+DavidLukešDvl"><i class="fa fa-google-plus-square fa-lg"></i> g+</a></li>
                <li class="list-group-item"><a href="https://www.facebook.com/fyodor.konstantinovitch.cherdyntsev"><i class="fa fa-facebook-square fa-lg"></i> facebook</a></li>
              </ul>
            </li>



            <li class="list-group-item"><a href="https://dlukes.github.io/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group " id="tags">
                    <li class="list-group-item tag-1">
                        <a href="https://dlukes.github.io/tag/floss.html">
                            floss
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://dlukes.github.io/tag/python.html">
                            python
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://dlukes.github.io/tag/bonito.html">
                            Bonito
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://dlukes.github.io/tag/r.html">
                            r
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://dlukes.github.io/tag/programming.html">
                            programming
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://dlukes.github.io/tag/automator.html">
                            automator
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://dlukes.github.io/tag/korpus.html">
                            korpus
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://dlukes.github.io/tag/kontext.html">
                            KonText
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://dlukes.github.io/tag/konkordance.html">
                            konkordance
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://dlukes.github.io/tag/noske.html">
                            NoSke
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://dlukes.github.io/tag/linguistics.html">
                            linguistics
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://dlukes.github.io/tag/osx.html">
                            osx
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/rust.html">
                            rust
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/wrap.html">
                            wrap
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/iframe.html">
                            iframe
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/html.html">
                            html
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/chomsky.html">
                            Chomsky
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/lines.html">
                            lines
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/gui.html">
                            gui
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/services.html">
                            services
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/par.html">
                            par
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/daemon.html">
                            daemon
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/emacsclient.html">
                            emacsclient
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/unicode.html">
                            unicode
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/emacs.html">
                            emacs
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/javascript.html">
                            javascript
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/airmail.html">
                            airmail
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/text-processing.html">
                            text processing
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/versioning.html">
                            versioning
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/shiny.html">
                            shiny
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/underscorejs.html">
                            underscore.js
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/library.html">
                            library
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/dependency.html">
                            dependency
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/perl.html">
                            perl
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/charset.html">
                            charset
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/semver.html">
                            semver
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/jupyter.html">
                            jupyter
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/monkey-patching.html">
                            monkey-patching
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/fill.html">
                            fill
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/wittgenstein.html">
                            Wittgenstein
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/dokuwiki.html">
                            dokuwiki
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/encoding.html">
                            encoding
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/spacemacs.html">
                            spacemacs
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/development.html">
                            development
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://dlukes.github.io/tag/hack.html">
                            hack
                        </a>
                    </li>
                </ul>
            </li>


    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.korpus.cz" target="_blank">
                Czech National Corpus
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://wodymarcowe.blogspot.cz" target="_blank">
                A blonde in Poland
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://xkcd.com" target="_blank">
                xkcd
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://pbfcomics.com" target="_blank">
                Perry Bible Fellowship
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://phdcomics.com/comics.php" target="_blank">
                PhD Comics
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 dlukes
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>              <p><small>  <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://dlukes.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://dlukes.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://dlukes.github.io/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'littleumbrellas'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>